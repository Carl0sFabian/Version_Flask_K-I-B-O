<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenido a K-I-B-O</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/Icon.png') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #02040A;
            --primary-color: #0077FF;
            --glass-bg: rgba(10, 25, 47, .6);
            --border-color: rgba(255, 255, 255, .1);
            --text-primary: #E6F1FF;
            --text-secondary: #8892B0
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            display: grid;
            place-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative
        }

        #test-connection-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            background-color: #ffc107;
            color: #000;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700
        }

        .aurora-background {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1400px;
            height: 1400px;
            transform: translate(-50%, -50%);
            overflow: hidden;
            filter: blur(100px);
            z-index: 1
        }

        .aurora {
            position: absolute;
            border-radius: 50%;
            opacity: .3
        }

        .aurora-1 {
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, #3a86ff, transparent 60%);
            animation: move-aurora-1 20s infinite alternate
        }

        .aurora-2 {
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, #ff006e, transparent 60%);
            animation: move-aurora-2 25s infinite alternate
        }

        @keyframes move-aurora-1 {
            from {
                transform: translate(-200px, -200px) rotate(0)
            }

            to {
                transform: translate(200px, 200px) rotate(360deg)
            }
        }

        @keyframes move-aurora-2 {
            from {
                transform: translate(200px, 200px) rotate(0)
            }

            to {
                transform: translate(-200px, -200px) rotate(-360deg)
            }
        }

        .auth-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, .37);
            position: relative;
            overflow: hidden;
            width: 850px;
            max-width: 95%;
            min-height: 550px;
            z-index: 2
        }

        .content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 300%;
            height: 100%;
            display: flex;
            transform: translateX(-33.3333%);
            transition: transform .8s cubic-bezier(.68, -.55, .27, 1.55)
        }

        .panel {
            width: calc(100%/3);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 40px;
            box-sizing: border-box
        }

        .bot-panel {
            text-align: center
        }

        .bot-wrapper {
            transition: transform .2s linear
        }

        .bot {
            animation: levitate 4s ease-in-out infinite;
            position: relative;
            cursor: pointer
        }

        @keyframes levitate {

            0%,
            to {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-15px)
            }
        }

        .bot-hand {
            width: 28px;
            height: 28px;
            background: #e0e2e5;
            border-radius: 50%;
            position: absolute;
            top: 60px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .2);
            animation: levitate-hands 4s ease-in-out infinite;
            transition: transform .3s cubic-bezier(.25, .46, .45, .94)
        }

        .bot-hand.left {
            left: -45px;
            animation-delay: .2s
        }

        .bot-hand.right {
            right: -45px
        }

        @keyframes levitate-hands {

            0%,
            to {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-10px)
            }
        }

        .bot-head {
            width: 140px;
            height: 110px;
            background: #f0f2f5;
            border-radius: 40px 40px 25px 25px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .2);
            transition: transform .3s cubic-bezier(.25, .46, .45, .94)
        }

        .bot:hover .bot-head {
            transform: rotate(5deg) scale(1.05)
        }

        .bot:hover .bot-hand.left {
            transform: translate(-10px, -15px) rotate(-20deg)
        }

        .bot:hover .bot-hand.right {
            transform: translate(10px, -15px) rotate(20deg)
        }

        .bot-screen {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 55px;
            background: #030d1a;
            border-radius: 15px;
            box-shadow: inset 0 0 10px var(--primary-color);
            animation: screen-glow 3s infinite alternate
        }

        @keyframes screen-glow {
            from {
                box-shadow: inset 0 0 10px var(--primary-color)
            }

            to {
                box-shadow: inset 0 0 20px #00ddff
            }
        }

        .eyes {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='20' viewBox='0 0 50 20'%3E%3Cpath d='M10 15 L15 5 L20 15 M30 15 L35 5 L40 15' stroke='%2300DDFF' stroke-width='3' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            filter: drop-shadow(0 0 5px #00ddff);
            animation: blink 5s infinite
        }

        @keyframes blink {

            0%,
            95%,
            to {
                opacity: 1
            }

            97% {
                opacity: .2
            }
        }

        .welcome-text h1 {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 30px
        }

        .welcome-text p {
            font-size: 1.1em;
            color: var(--text-secondary);
            margin-top: 5px
        }

        .welcome-actions {
            margin-top: 30px;
            display: flex;
            gap: 20px
        }

        .form-panel {
            text-align: center;
            position: relative
        }

        form h1 {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary)
        }

        form p {
            color: var(--text-secondary);
            margin-bottom: 15px
        }

        .social-container a {
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
            height: 40px;
            width: 40px;
            color: var(--text-secondary);
            transition: all .3s ease
        }

        .social-container a:hover {
            color: var(--text-primary);
            border-color: var(--primary-color)
        }

        .role-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0
        }

        .role-selector input[type=radio] {
            display: none
        }

        .role-selector label {
            padding: 8px 18px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all .3s ease
        }

        .role-selector input[type=radio]:checked+label {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color)
        }

        .input-group {
            position: relative;
            margin: 10px 0;
            width: 100%
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            transition: color .3s ease
        }

        input {
            background-color: rgba(0, 0, 0, .2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 15px 12px 40px;
            width: 100%;
            box-sizing: border-box;
            color: var(--text-primary);
            outline: 0;
            transition: border-color .3s ease
        }

        input:focus {
            border-color: var(--primary-color)
        }

        input:focus~i {
            color: var(--primary-color)
        }

        a.forgot-password {
            color: var(--primary-color);
            font-size: 14px;
            text-decoration: none;
            margin: 15px 0;
            display: inline-block
        }

        button {
            border-radius: 10px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            padding: 12px 45px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all .3s ease;
            cursor: pointer
        }

        button:hover {
            box-shadow: 0 0 20px rgba(0, 119, 255, .5);
            transform: translateY(-2px)
        }

        button.ghost {
            background-color: transparent;
            border-color: var(--text-primary)
        }

        .back-to-welcome-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            background: 0 0;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: grid;
            place-items: center
        }

        .back-to-welcome-btn:hover {
            color: var(--text-primary);
            border-color: var(--primary-color);
            background-color: transparent;
            transform: none;
            box-shadow: none
        }

        .auth-container.show-login .content-wrapper {
            transform: translateX(0)
        }

        .auth-container.show-welcome .content-wrapper {
            transform: translateX(-33.3333%)
        }

        .auth-container.show-signup .content-wrapper {
            transform: translateX(-66.6666%)
        }
    </style>
</head>

<body class="login-page">
    <button id="test-connection-btn">Probar Conexión</button>
    <div class="aurora-background">
        <div class="aurora aurora-1"></div>
        <div class="aurora aurora-2"></div>
    </div>
    <div class="auth-container" id="auth-container">
        <div class="content-wrapper" id="content-wrapper">
            <div class="panel form-panel">
                <button class="back-to-welcome-btn" title="Volver"><i class="fas fa-arrow-left"></i></button>
                <form id="login-form">
                    <h1>Iniciar Sesión</h1>
                    <div class="social-container"><a href="#" class="social"><i class="fab fa-google-plus-g"></i></a><a
                            href="#" class="social"><i class="fab fa-facebook-f"></i></a><a href="#" class="social"><i
                                class="fab fa-github"></i></a></div>
                    <p>o usa tu cuenta</p>
                    <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="login-email"
                            placeholder="Correo" required /></div>
                    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="login-password"
                            placeholder="Contraseña" required /></div><a href="#" class="forgot-password">¿Olvidaste tu
                        contraseña?</a><button type="submit">Iniciar Sesión</button>
                </form>
            </div>
            <div class="panel bot-panel" id="bot-panel">
                <div class="bot-wrapper" id="bot-wrapper">
                    <div class="bot">
                        <div class="bot-hand left"></div>
                        <div class="bot-head">
                            <div class="bot-screen">
                                <div class="eyes"></div>
                            </div>
                        </div>
                        <div class="bot-hand right"></div>
                    </div>
                </div>
                <div class="welcome-text">
                    <h1>¡Hola, soy K-I-B-O!</h1>
                    <p>Tu asistente inteligente. ¿Estás listo para empezar?</p>
                </div>
                <div class="welcome-actions"><button id="show-login-btn">Iniciar Sesión</button><button
                        id="show-signup-btn" class="ghost">Crear Cuenta</button></div>
            </div>
            <div class="panel form-panel">
                <button class="back-to-welcome-btn" title="Volver"><i class="fas fa-arrow-left"></i></button>
                <form id="signup-form">
                    <h1>Crear Cuenta</h1>
                    <div class="role-selector"><input type="radio" id="role-user" name="role" value="user"
                            checked><label for="role-user">Estudiante</label><input type="radio" id="role-teacher"
                            name="role" value="teacher"><label for="role-teacher">Profesor</label></div>
                    <div class="input-group"><i class="fas fa-user"></i><input type="text" id="signup-name"
                            placeholder="Nombre" required /></div>
                    <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="signup-email"
                            placeholder="Correo" required /></div>
                    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="signup-password"
                            placeholder="Contraseña" required /></div>
                    <button type="submit" style="margin-top: 10px;">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div>
    <script>const container = document.getElementById("auth-container"), showLoginBtn = document.getElementById("show-login-btn"), showSignupBtn = document.getElementById("show-signup-btn"), backBtns = document.querySelectorAll(".back-to-welcome-btn"); container.classList.add("show-welcome"), showLoginBtn.addEventListener("click", () => { container.classList.remove("show-welcome", "show-signup"), container.classList.add("show-login") }), showSignupBtn.addEventListener("click", () => { container.classList.remove("show-welcome", "show-login"), container.classList.add("show-signup") }), backBtns.forEach(e => { e.addEventListener("click", t => { t.preventDefault(), container.classList.remove("show-login", "show-signup"), container.classList.add("show-welcome") }) });</script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQa0qbVaqTvpFGAJjFj2BTRm1c29z48fw",
            authDomain: "k-i-b-o-24cbe.firebaseapp.com",
            projectId: "k-i-b-o-24cbe",
            storageBucket: "k-i-b-o-24cbe.appspot.com",
            messagingSenderId: "983754137013",
            appId: "1:983754137013:web:31731ce76eb8c036d7cdfc",
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            console.log("Firebase se inicializó correctamente.");

            document.getElementById('test-connection-btn').addEventListener('click', async () => {
                try {
                    await fetch(`https://${auth.app.options.authDomain}`, { mode: 'no-cors' });
                    alert('✅ ¡Prueba de Conexión Exitosa! La red parece estar bien.');
                } catch (error) {
                    alert('❌ ¡Prueba de Conexión Fallida! Hay un problema de red. Revisa tu antivirus, firewall o VPN.');
                    console.error("Error en prueba de conexión:", error);
                }
            });

            const signupForm = document.getElementById('signup-form');
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = signupForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'CREANDO...';

                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const role = document.querySelector('input[name="role"]:checked').value;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    const avatarUrl = `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(name)}`;
                    await updateProfile(user, {
                        displayName: name,
                        photoURL: avatarUrl
                    });

                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: email,
                        role: role,
                        avatarUrl: avatarUrl
                    });

                    alert(`¡Cuenta para ${name} creada exitosamente!`);
                    // Redirige a la ruta raíz '/' que ahora es controlada por Flask
                    window.location.href = '/';

                } catch (error) {
                    console.error('Error al crear usuario:', error.code, error.message);
                    let userMessage = "Ocurrió un error al registrar la cuenta.";
                    if (error.code === 'auth/email-already-in-use') {
                        userMessage = 'Error: El correo electrónico ya está en uso.';
                    } else if (error.code === 'auth/network-request-failed') {
                        userMessage = 'Error de Red: No se pudo conectar a Firebase. Por favor, revisa tu conexión, antivirus, firewall y asegúrate de que los dominios (localhost, 127.0.0.1) estén autorizados en Firebase Authentication.';
                    } else {
                        userMessage += ` (${error.code})`;
                    }
                    alert(userMessage);
                    submitButton.disabled = false;
                    submitButton.textContent = 'CREAR CUENTA';
                }
            });

            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password)
                    // Redirige a la ruta raíz '/' que ahora es controlada por Flask
                    .then(() => { window.location.href = '/'; })
                    .catch(() => { alert("Correo o contraseña incorrectos."); });
            });

        } catch (e) {
            console.error("Error fatal al inicializar Firebase. Revisa tu `firebaseConfig`.", e);
            alert("Error fatal al inicializar Firebase. Revisa la consola para más detalles.");
        }
    </script>
</body>

</html>